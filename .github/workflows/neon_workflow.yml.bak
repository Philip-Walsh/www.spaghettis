name: Neon Database Branch Management

on:
    pull_request:
        types: [opened, reopened, synchronize, closed]

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

permissions:
    contents: read
    pull-requests: write

jobs:
    setup:
        name: Setup Branch Info
        runs-on: ubuntu-latest
        outputs:
            branch: ${{ steps.branch_name.outputs.current_branch }}
        steps:
            - name: Get branch name
              id: branch_name
              uses: tj-actions/branch-names@v8

    create_neon_branch:
        name: Create Neon Branch & Run Migrations
        runs-on: ubuntu-latest
        needs: setup
        if: |
            github.event_name == 'pull_request' && (
              github.event.action == 'synchronize' ||
              github.event.action == 'opened' ||
              github.event.action == 'reopened'
            )
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Create Neon Branch
              id: create_neon_branch
              uses: neondatabase/create-branch-action@v5
              with:
                  project_id: ${{ vars.NEON_PROJECT_ID }}
                  branch_name: preview/pr-${{ github.event.number }}-${{ needs.setup.outputs.branch }}
                  username: neondb_owner
                  api_key: ${{ secrets.NEON_API_KEY }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '18'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Run database migrations
              run: npm run db:migrate
              env:
                  DATABASE_URL: ${{ steps.create_neon_branch.outputs.db_url_with_pooler }}
                  NETLIFY_DATABASE_URL: ${{ steps.create_neon_branch.outputs.db_url_with_pooler }}
                  NETLIFY_DATABASE_URL_UNPOOLED: ${{ steps.create_neon_branch.outputs.db_url }}

            - name: Post Schema Diff Comment to PR
              uses: neondatabase/schema-diff-action@v1
              with:
                  project_id: ${{ vars.NEON_PROJECT_ID }}
                  compare_branch: preview/pr-${{ github.event.number }}-${{ needs.setup.outputs.branch }}
                  api_key: ${{ secrets.NEON_API_KEY }}
                  username: neondb_owner
                  database: neondb

    delete_neon_branch:
        name: Delete Neon Branch
        runs-on: ubuntu-latest
        needs: setup
        if: github.event_name == 'pull_request' && github.event.action == 'closed'
        steps:
            - name: Delete Neon Branch
              uses: neondatabase/delete-branch-action@v3
              with:
                  project_id: ${{ vars.NEON_PROJECT_ID }}
                  branch: preview/pr-${{ github.event.number }}-${{ needs.setup.outputs.branch }}
                  api_key: ${{ secrets.NEON_API_KEY }}
